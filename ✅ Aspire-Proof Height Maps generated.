import os
import numpy as np
from PIL import Image

from pipeline.loader import load_gray
from pipeline.illumination import remove_illumination
from pipeline.form_only import keep_form_only
from pipeline.z_lock import lock_height
from pipeline.background import fade_edges
from config import INPUT_DIR, OUTPUT_DIR

# --- Ensure folders exist ---
os.makedirs(INPUT_DIR, exist_ok=True)
os.makedirs(OUTPUT_DIR, exist_ok=True)

print("▶ Aspire-Proof Height Map Pipeline starting...")

# --- Batch process ---
for fname in os.listdir(INPUT_DIR):
    if not fname.lower().endswith((".png", ".jpg", ".jpeg", ".tif", ".tiff")):
        continue

    in_path = os.path.join(INPUT_DIR, fname)
    out_path = os.path.join(OUTPUT_DIR, fname)

    print(f"▶ Processing: {fname}")

    # 1) Load (robust, grayscale)
    img = load_gray(in_path)              # uint8, 2D

    # 2) Remove illumination / shadow
    img = remove_illumination(img)

    # 3) Preserve original form only
    img = keep_form_only(img)

    # 4) Lock Z height (Aspire safe)
    img = lock_height(img)

    # 5) Fade edges to black
    img = fade_edges(img)

    # 6) FORCE pure grayscale save (single channel)
    img = img.astype(np.uint8)
    Image.fromarray(img, mode="L").save(out_path)

print("✅ Aspire-Proof Height Maps generated.")
